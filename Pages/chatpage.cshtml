@page
@model ChatModel
@{
    ViewData["Title"] = "Chat em Tempo Real";
}
<!--
// v0 by Vercel.
// https://v0.dev/t/65oN8m9060j
-->

<div class="grid grid-cols-[280px_1fr] h-[80vh] max-h-[800px] w-full bg-background rounded-xl overflow-hidden">
    <div class="border-r bg-muted/20 p-4 flex flex-col gap-4 overflow-auto">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">Conversations</h3>
            <button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 w-10">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="24"
                     height="24"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2"
                     stroke-linecap="round"
                     stroke-linejoin="round"
                     class="w-5 h-5">
                    <path d="M5 12h14"></path>
                    <path d="M12 5v14"></path>
                </svg>
                <span class="sr-only">New Conversation</span>
            </button>
        </div>
        <div class="flex flex-col gap-2">
            <a class="flex items-center gap-3 p-2 rounded-md hover:bg-muted transition-colors" href="#">
                <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                    <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                </span>
                <div class="flex-1 truncate">
                    <div class="font-medium">John Doe</div>
                    <div class="text-sm text-muted-foreground truncate">Hey, did you see the new design?</div>
                </div>
                <div class="text-xs text-muted-foreground">2:34 PM</div>
            </a>
            <a class="flex items-center gap-3 p-2 rounded-md hover:bg-muted transition-colors" href="#">
                <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                    <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                </span>
                <div class="flex-1 truncate">
                    <div class="font-medium">Jane Smith</div>
                    <div class="text-sm text-muted-foreground truncate">Sounds good, let's discuss it in the meeting.</div>
                </div>
                <div class="text-xs text-muted-foreground">11:24 AM</div>
            </a>
            <a class="flex items-center gap-3 p-2 rounded-md hover:bg-muted transition-colors" href="#">
                <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                    <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                </span>
                <div class="flex-1 truncate">
                    <div class="font-medium">Michael Brown</div>
                    <div class="text-sm text-muted-foreground truncate">I'm running late, can we reschedule?</div>
                </div>
                <div class="text-xs text-muted-foreground">9:41 AM</div>
            </a>
        </div>
    </div>
    <div class="flex flex-col">
        <div class="flex-1 p-6 overflow-auto">
            <div class="grid gap-4">
                <div class="flex items-start gap-4">
                    <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                        <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                    </span>
                    <div class="bg-muted rounded-2xl p-4 max-w-[70%]">
                        <div class="font-medium">John Doe</div>
                        <div class="text-sm">Hey, did you see the new design?</div>
                        <div class="text-xs text-muted-foreground mt-2">2:34 PM</div>
                    </div>
                </div>
                <div class="flex items-start gap-4 justify-end">
                    <div class="bg-primary rounded-2xl p-4 max-w-[70%] text-primary-foreground">
                        <div>Looks great! I really like the new color scheme.</div>
                        <div class="text-xs text-primary-foreground/80 mt-2">2:35 PM</div>
                    </div>
                    <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                        <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                    </span>
                </div>
                <div class="flex items-start gap-4">
                    <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                        <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                    </span>
                    <div class="bg-muted rounded-2xl p-4 max-w-[70%]">
                        <div class="font-medium">John Doe</div>
                        <div>Yeah, the team did a great job. We should discuss it in the next meeting.</div>
                        <div class="text-xs text-muted-foreground mt-2">2:36 PM</div>
                    </div>
                </div>
                <div class="flex items-start gap-4 justify-end">
                    <div class="bg-primary rounded-2xl p-4 max-w-[70%] text-primary-foreground">
                        <div>Sounds good, I'll add it to the agenda.</div>
                        <div class="text-xs text-primary-foreground/80 mt-2">2:37 PM</div>
                    </div>
                    <span class="relative flex shrink-0 overflow-hidden rounded-full w-10 h-10 border">
                        <img class="aspect-square h-full w-full" alt="Avatar" src="/placeholder-user.jpg" />
                    </span>
                </div>
            </div>
        </div>
        <div class="border-t p-4">
            <div class="relative">
                <textarea class="flex border border-input bg-background text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[48px] rounded-2xl resize-none p-4 pr-16 w-full"
                          placeholder="Type your message..."></textarea>
                <button class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 absolute w-8 h-8 top-3 right-3"
                        type="submit"></button>
            </div>
        </div>
    </div>
</div>

<!--<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <a href="./index" class="btn btn-link"><i class="bi bi-arrow-left"></i></a>
            <h1 class="text-center">ChatBot Project</h1>
            <div id="messagesContainer" class="border rounded p-3 mb-4" style="height: 400px; overflow-y: auto;">
                <ul id="messagesList" class="list-group"></ul>
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control form-control-sm rounded-pill" placeholder="Digite sua mensagem..." style="border: 2px solid #007bff; padding: 19px 20px;" />
                <div class="input-group-append">
                    <button class="btn btn-success btn-sm rounded-pill" onclick="sendMessage()" style="padding: 5px 13px;">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
    -->
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
    <script>
        // Cria a conexão com o SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        // Define o que fazer ao receber uma mensagem
        connection.on("ReceiveMessage", (user, message) => {
            const li = document.createElement("li");
            li.className = "list-group-item text-right";
            li.textContent = `${user}: ${message}`;
            const messagesList = document.getElementById("messagesList");
            messagesList.appendChild(li);
        });

        // Inicia a conexão com o SignalR
        connection.start()
            .then(() => {
                console.log("Conexão estabelecida.");
            })
            .catch(err => {
                console.error("Erro ao estabelecer conexão:", err.toString());
            });

        // Função para enviar mensagem
        function sendMessage() {
            const message = document.getElementById("messageInput").value;

            // Envia a mensagem para o Hub
            connection.invoke("SendMessage", message)
                .then(() => {
                    // Limpa o campo de mensagem após envio
                    document.getElementById("messageInput").value = '';

                    // Scroll para o final
                    const messagesContainer = document.getElementById("messagesContainer");
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                })
                .catch(err => {
                    console.error("Erro ao enviar mensagem:", err.toString());
                });
        }


        // Event listener para enviar mensagem ao pressionar Enter
        document.getElementById("messageInput").addEventListener("keydown", function (event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
}
